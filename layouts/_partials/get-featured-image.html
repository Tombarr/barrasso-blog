{{/*
GetFeaturedImage

This partial gets the url for featured image for a given page.

If a featured_image or featureImage was set in the page's front matter, then that will be used.

If not set, this will search page resources to find an image that contains the word
"cover", and if found, returns the path to that resource.

If no featured_image was set, and there's no "cover" image in page resources, then
this partial returns the site's default featured image from config, or an empty string.

Usage:
  {{ partial "get-featured-image.html" . }}                              - Returns relative URL
  {{ partial "get-featured-image.html" (dict "Page" . "absolute" true) }} - Returns absolute URL

@param Page - The page context (required)
@param absolute - If true, returns absolute URLs (for SEO meta tags). Default: false
@return URL to featured image, or an empty string if not found.

*/}}

{{/* Handle both direct page context and dict context */}}
{{ $page := . }}
{{ $absolute := false }}
{{ if reflect.IsMap . }}
  {{ $page = .Page }}
  {{ $absolute = .absolute | default false }}
{{ end }}

{{/* Declare a new string variable, $linkToCover */}}
{{ $linkToCover := "" }}
{{ $imageKeys := slice "featured_image" "featureImage" "cover" "banner" }}

{{/* Check for any of the specified keys in front matter */}}
{{ range $imageKeys }}
{{ $paramValue := index $page.Params . }}
{{ with $paramValue }}
{{ $cleanPath := strings.TrimPrefix "/" . }}
{{/* First check local page resources (content directory) */}}
{{ $pageResource := $page.Resources.GetMatch . }}
{{ if $pageResource }}
  {{ if $absolute }}
    {{ $linkToCover = $pageResource.Permalink }}
  {{ else }}
    {{ $linkToCover = $pageResource.RelPermalink }}
  {{ end }}
{{ else }}
{{/* Then try global site-wide assets */}}
{{ $resource := resources.Get $cleanPath }}
{{ if $resource }}
  {{ if $absolute }}
    {{ $linkToCover = $resource.Permalink }}
  {{ else }}
    {{ $linkToCover = $resource.RelPermalink }}
  {{ end }}
{{ else }}
{{/* Fallback to absolute URL (external images are always absolute) */}}
{{ $linkToCover = trim . "/" | absURL }}
{{ end }}
{{ end }}
{{ break }}
{{ end }}
{{ end }}

{{/* If no image found in front matter, search in page resources */}}
{{ if not $linkToCover }}
{{ with $page.Resources.ByType "image" }}
{{ $resourceMatch := .GetMatch (printf "**{%s}*" (delimit $imageKeys ",")) }}
{{ range $imageKeys }}
{{ $exactMatch := $page.Resources.GetMatch . }}
{{ if $exactMatch }}
  {{ if $absolute }}
    {{ $linkToCover = $exactMatch.Permalink }}
  {{ else }}
    {{ $linkToCover = $exactMatch.RelPermalink }}
  {{ end }}
{{ break }}
{{ end }}
{{ end }}
{{ if and (not $linkToCover) $resourceMatch }}
  {{ if $absolute }}
    {{ $linkToCover = $resourceMatch.Permalink }}
  {{ else }}
    {{ $linkToCover = $resourceMatch.RelPermalink }}
  {{ end }}
{{ end }}
{{ end }}
{{ end }}

{{/* If no cover image is found, use the site's default featured image from config */}}
{{ if not $linkToCover }}
{{ with $page.Site.Params.defaultFeaturedImage }}
  {{ if $absolute }}
    {{ $linkToCover = (printf "%v/%v" $page.Site.BaseURL (trim . "/")) }}
  {{ else }}
    {{ $linkToCover = (printf "/%v" (trim . "/")) }}
  {{ end }}
{{ else }}
{{/* Fallback to site avatar if no default featured image is configured */}}
{{ with $page.Site.Params.avatar }}
  {{ if $absolute }}
    {{ $linkToCover = (printf "%v/%v" $page.Site.BaseURL (trim . "/")) }}
  {{ else }}
    {{ $linkToCover = (printf "/%v" (trim . "/")) }}
  {{ end }}
{{ end }}
{{ end }}
{{ end }}

{{/* return either a permalink, or an empty string. */}}
{{ return $linkToCover }}
