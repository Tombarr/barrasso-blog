# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Hugo static site blog (barrasso.me) using the [Henry theme](https://github.com/kaushikgopal/henry-hugo) with Tailwind CSS for styling. The project supports two content types: regular blog posts and "shorts" (shorter form content).

## Development Commands

All development is orchestrated through the Makefile:

```bash
# First time setup (required after clone or in new environment)
make setup              # Install npm dependencies and compile initial CSS

# Run the development server (default command)
make                    # Runs Hugo server + Tailwind CSS watcher in parallel
make run                # Same as default

# Build the site (one-time)
make build              # Compiles CSS first, then Hugo build
make site               # Hugo build only (requires CSS to exist)
make css                # Tailwind CSS compilation only

# Create new content
make post slug=my-post-title    # Creates new blog post with date prefix
make short slug=my-short        # Creates new short with date prefix

# Utilities
make clean              # Remove generated files (public/, output.css)
make help               # List all available commands
```

**IMPORTANT:** After cloning the repository or opening in a new environment (like devcontainer), you MUST run `make setup` or `make css` before running Hugo, as the CSS file (`assets/css/output.css`) is git-ignored and needs to be generated.

### Running with Caddy (optional)

```bash
make run-caddy          # Copies Caddyfile and starts Caddy server
# Stop with: brew services stop caddy
```

### Logging levels

All Hugo commands support optional log levels:

```bash
make build log=debug    # Options: debug|info|warn|error (default: warn)
```

## Architecture

### Configuration Structure

Hugo uses environment-specific configurations in `config/`:

- `config/_default/hugo.toml` - Base configuration (localhost, theme: henry)
- `config/production/hugo.toml` - Production overrides (baseURL: https://barrasso.me/)
- `config/local/hugo.toml` - Local development overrides (if needed)

Hugo automatically merges these based on the environment.

**Required parameters in config:**

- `params.authors` - Array of author objects (required by Henry theme)
- `params.copyright` - Copyright and licensing information
  - `params.copyright.holder` - Copyright holder name
  - `params.copyright.year` - Copyright year
  - `params.copyright.contentLicense.name` - Content license name
  - `params.copyright.contentLicense.url` - Content license URL
  - `params.copyright.codeLicense.name` - Code license name
  - `params.copyright.codeLicense.url` - Code license URL

### Theme Architecture

The site uses the **Henry theme** located in `themes/henry/`. There's also a `themes/dura/` directory, but the active theme is Henry (as set in config).

**Important customization pattern:**

- Theme-level files in `themes/henry/` provide defaults
- Root-level files override theme files (Hugo's lookup order)
- Currently customized files in root:
  - `themes/dura/` contains customized layouts, assets, etc.
  - Root `assets/css/input.css` can import and extend theme CSS

### Content Types & Archetypes

Two content types with date-based slugs:

1. **Posts** (regular blog posts)
   - Created via: `make post slug=title`
   - Archetype: `themes/henry/archetypes/post.md`
   - Stored in: `content/posts/YYYY-MM-DD-slug.md`
   - Slug auto-generated by removing date prefix from filename

2. **Shorts** (short-form content)
   - Created via: `make short slug=title`
   - Archetype: `themes/henry/archetypes/short.md`
   - Stored in: `content/blog/YYYY-MM-DD-slug.md`
   - Has `type: 'shorts'` in frontmatter

**Frontmatter features** (both types support):

- `timeless: true` - Pages without dates
- `frontpage: true` - Pin to frontpage
- `externalLink` - Daring Fireball-style external links
- `canonicalUrl` - For cross-posted content
- `banner` - Header images (used for meta/og tags and optional display)
- `showBanner: true` - Display banner image below post title
- `bannerCaption` - Optional caption for banner image (supports markdown)
- `aliases` - URL redirects
- `bsky` - Bluesky integration

### Shortcodes

Custom shortcodes available for content creation:

#### GitHub Gist Embed

Embed GitHub Gists with local rendering and syntax highlighting.

**Usage:**

```markdown
{{</* gist username gist-id */>}}
{{</* gist username gist-id filename.js */>}}
```

**Parameters:**

- `username` (required) - GitHub username
- `gist-id` (required) - Gist ID (from the gist URL)
- `filename` (optional) - Specific file to display if gist contains multiple files

**Features:**

- Fetches gist content via GitHub API
- Server-side syntax highlighting using Hugo's Chroma
- Line numbers displayed in table format
- GitHub-like UI with header and footer
- Dark mode support
- "View raw" link to original gist file
- Error handling for missing gists or files

**Example:**

```markdown
{{</* gist torvalds 1f09b4096abc7310fb435f6e6c32ae13 */>}}
```

**Note:** Requires internet connection during build time to fetch gist content.

#### Responsive Images

Automatically generate responsive images with multiple sizes and modern formats (WebP + original).

**Usage:**

```markdown
{{</* responsive-image src="images/photo.jpg" alt="Description" */>}}
{{</* responsive-image src="images/photo.jpg" alt="Description" class="my-class" */>}}
{{</* img "images/photo.jpg" "Alt text" */>}}
```

**Parameters:**

- `src` (required) - Path to image in `assets/` or page resources (e.g., `images/photo.jpg`)
- `alt` (optional) - Alt text for accessibility
- `class` (optional) - CSS classes to add to `<img>` element
- `sizes` (optional) - `sizes` attribute for responsive images (default: `"100vw"`)
- `widths` (optional) - Comma-separated widths to generate (default: `"320,640,1024,1920"`)
- `loading` (optional) - `"lazy"` (default) or `"eager"`
- `quality` (optional) - JPEG/WebP quality 1-100 (default: 85)

**Features:**

- **Automatic WebP generation** - Creates WebP versions alongside original format
- **Multiple sizes** - Generates srcset with 320w, 640w, 1024w, 1920w (customizable)
- **Picture element** - Uses `<picture>` with format fallbacks
- **Lazy loading** - Enabled by default with native `loading="lazy"`
- **Proper dimensions** - Includes `width` and `height` to prevent layout shift
- **Hugo image processing** - Works with images in `assets/` or page bundles

**Example:**

```markdown
{{</* responsive-image
  src="images/screenshot.png"
  alt="Application screenshot"
  class="border rounded-lg"
  sizes="(max-width: 768px) 100vw, 50vw"
  widths="400,800,1200"
*/>}}
```

**Shortcode alias:**

- `img` - Simpler syntax: `{{</* img "path/to/image.jpg" "Alt text" */>}}`

**Output:**

```html
<picture>
  <source
    type="image/webp"
    srcset="/images/photo_320.webp 320w, /images/photo_640.webp 640w, ..."
    sizes="100vw" />
  <source
    type="image/jpeg"
    srcset="/images/photo_320.jpg 320w, /images/photo_640.jpg 640w, ..."
    sizes="100vw" />
  <img
    src="/images/photo_320.jpg"
    alt="Description"
    width="320"
    height="240"
    loading="lazy"
    decoding="async" />
</picture>
```

**Performance benefits:**

- **30-50% smaller** - WebP format reduces file size significantly
- **Responsive** - Correct image size loaded for each viewport
- **Lazy loading** - Images only load when needed
- **No layout shift** - Explicit dimensions prevent CLS

**Implementation:**

- Shortcode: `layouts/shortcodes/responsive-image.html`
- Partial: `layouts/partials/responsive-image.html` (reusable in templates)
- Used in: Project cards, feature images, content images

### CSS/Styling

Tailwind CSS v4 workflow:

- **Input**: `assets/css/input.css` - Source CSS with imports and custom styles
- **Output**: `assets/css/output.css` - Compiled CSS (~48KB, git-ignored)
- **Build command**: `make css` or `npx @tailwindcss/cli -i ./assets/css/input.css -o ./assets/css/output.css`
- **Watch mode**: Runs automatically with `make run` (parallel with Hugo server)

**Fonts:**

- **Self-hosted fonts** (no Google Fonts): Figtree (body) and Fraunces (titles)
- Font files stored in `static/fonts/` (committed to git)
- Font declarations in `assets/css/fonts-local.css`
- Total font size: ~305KB (4 files: normal + italic for each font)

**Current configuration in `assets/css/input.css`:**

```css
@import 'tailwindcss';

/* Tell Tailwind where to scan for classes */
@source "../../themes/henry/layouts/**/*.html";
@source "../../layouts/**/*.html";
@source "../../content/**/*.md";

/* Self-hosted fonts (replaces Google Fonts) */
@import './fonts-local.css';

/* Import Henry theme styles */
@import '../../themes/henry/assets/css/theme.css';
@import '../../themes/henry/assets/css/henry.css';

/* Add custom styles in @layer components or utilities */
@layer components {
  /* Your custom styles here */
}
```

**How CSS is loaded:**

- Hugo's `styles.html` partial uses `resources.Get "css/output.css"`
- In production, CSS is minified and fingerprinted for cache-busting
- The `@source` directives tell Tailwind v4 where to scan for utility classes
- All Henry theme variables (like `--color-hbg`, `--color-ht`) are imported and available
- Fonts loaded from `/fonts/` path (served from `static/fonts/`)

### JavaScript/ESBuild

JavaScript bundling via ESBuild (integrated with Hugo's `js.Build`):

- **Entry point**: `assets/js/main.js`
- **Modules**: Place reusable modules in `assets/js/modules/`
- **Output**: Hugo automatically bundles all imports into a single file
- **Transpilation**: Configured to transpile to ES2015
- **Loading**: Script loaded with `defer` attribute (via `layouts/_partials/scripts.html`)
- **Production**: Auto-minified and fingerprinted in production builds

**Current modules:**

- `tree-landscape.js` - Procedural tree canvas generation for footer
- `theme-toggle.js` - Dark/light mode switching with localStorage persistence

**How to add JavaScript:**

1. Import modules in `assets/js/main.js` (e.g., `import { fn } from './modules/mymodule.js'`)
2. All imported files are automatically bundled
3. Hugo's `js.Build` handles ESBuild invocation
4. No separate build step needed - runs automatically with Hugo

**Template implementation:**

- `layouts/baseof.html` - Overrides theme baseof to include scripts partial
- `layouts/_partials/scripts.html` - Handles JS bundling with ESBuild options

### Theme Toggle

A dark/light mode toggle has been added to the header:

- **Location**: Top-right corner, inline with search icon
- **Icons**: Sun icon (shown in dark mode), Moon icon (shown in light mode)
- **Persistence**: User preference saved to localStorage
- **System preference**: Respects `prefers-color-scheme` if no preference set
- **Default**: Dark mode
- **Implementation**: `assets/js/modules/theme-toggle.js`
- **Template**: `layouts/_partials/header.html` (custom override)

**Theme color customization:**

- Custom color overrides in `assets/css/input.css` for both light and dark modes
- **Light mode**: White background (#ffffff) with dark text (slate-800)
- **Dark mode**: Dark background (#1c2b33) with light text (slate-200)
- All text colors adjusted for WCAG-compliant contrast ratios
- Accent colors: Yellow for light mode, Orange for dark mode

### Homepage Avatar

The homepage includes a circular portrait avatar that randomly displays one of 16 portraits from a 4x4 grid:

- **Image source**: `static/images/portraits.jpg` (4x4 grid of portrait variations)
- **Display**: 200px Ã— 200px circular avatar, positioned to the left of the hero text, top-aligned
- **Layout approach**:
  - Portrait positioned absolutely within relative container (`.hero-with-portrait`)
  - Text content has 240px left padding (200px portrait + 40px gap)
  - Container has `min-height: 200px` to ensure proper height
- **CSS-first approach**:
  - Explicit `width` and `height` prevent layout shift on page load
  - 16 data attribute selectors with explicit `background-position` values (0%, 33.333333%, 66.666667%, 100%)
  - Default `data-portrait="0"` displays first portrait without JavaScript
- **Random selection**: Minimal inline JavaScript randomly sets `data-portrait` attribute (0-15) on page load
  - Runs immediately after element (no DOMContentLoaded wait) to prevent flash
  - Graceful degradation: works without JavaScript (shows portrait 0)
- **Styling**: Border color changes based on theme (dark border in light mode, light border in dark mode)
- **Implementation**:
  - CSS: `.portrait-variation[data-portrait="N"]` selectors in `assets/css/input.css`
  - Template: `layouts/home.html` (custom home layout with portrait div and inline script)
  - No separate JavaScript module needed

### Footer Customization

The footer has been customized to include:

- **Tree landscape divider**: Dynamic canvas-based procedural tree generation from Dura theme
  - JavaScript: `assets/js/modules/tree-landscape.js` - Contains tree drawing algorithms
  - Canvas element: Rendered in footer with random forest on each page load
  - **Theme-aware**: Automatically displays correct tree colors when theme changes
    - Trees always drawn in white (#ffffff)
    - CSS `filter: invert(1)` applied in light mode to show black trees
    - CSS `filter: invert(0)` applied in dark mode to show white trees
    - Smooth 0.3s transition when theme toggles without page reload
  - Styling: `.tree-divider-container` in `assets/css/input.css`
- **Copyright & Licensing**: Configured via `params.copyright` in Hugo config
  - Copyright holder, year, and licenses are pulled from config parameters
  - Content and code licenses displayed with links
  - All theme attribution removed (no "Powered by" mentions)

**Implementation:**

- `layouts/_partials/footer.html` - Custom footer override with canvas and copyright
- Copyright text configured in `config/hugo.toml` under `params.copyright`
- Tree rendering: `getTreeColor()` function in `tree-landscape.js` (always returns white)
- Theme adaptation: CSS invert filter in `assets/css/input.css` handles color switching

### Development Container

A `.devcontainer.json` is configured with:

- Debian Trixie base image
- Hugo Extended (required for SCSS support)
- Node.js LTS (for Tailwind)
- Port 1313 auto-forwarded with preview
- Recommended VS Code extensions for Hugo/Markdown/TOML

## Key Technical Details

- Hugo runs on port 1313 by default
- Builds use: `--cleanDestinationDir --gc --minify --printI18nWarnings`
- Server uses: `--disableFastRender` for accurate rebuilds
- Draft posts are included in builds (via `--buildDrafts`)
- Production URL: https://barrasso.me/
- Tailwind CLI: `@tailwindcss/cli` package (not full Tailwind)
- ESBuild: Integrated via Hugo's `js.Build` pipe (requires esbuild npm package)
- Required npm packages: `esbuild`, `@tailwindcss/cli`, `tailwindcss`

## Code Formatting with Prettier

The project uses Prettier with `prettier-hugo-plugin` to format Hugo template files.

### Configuration

- **Config file**: `.prettierrc` with Hugo-specific settings
- **Ignore file**: `.prettierignore` - excludes generated files and complex partials
- **Print width**: 200 characters for HTML files (to prevent excessive line wrapping in templates)
- **Parser**: `go-template` for `*.html` files

### Important: Hugo Template Gotchas

Prettier can break Hugo templates in several ways that cause build errors:

#### 1. Split Comment Delimiters

**Problem**: Comment closing delimiters separated across lines

**Bad** (causes "comment ends before closing delimiter"):

```html
{{- /* This is a very long comment that gets wrapped */ -}}
```

**Good**:

```html
{{- /* This is a very long comment that gets wrapped */ -}}
```

**Rule**: The `*/` and `-}}` must **always be on the same line**.

#### 2. Split Strings (CRITICAL)

**Problem**: Prettier splits long strings across multiple lines, causing "unterminated quoted string" errors

**Bad** (causes Hugo build failure):

```html
{{- partial "image.html" (dict "class" "my-class" "sizes" "(max-width: 768px)
100vw, 50vw") -}}
```

**Good**:

```html
{{- partial "image.html" (dict "class" "my-class" "sizes" "(max-width: 768px)
100vw, 50vw") -}}
```

**Rule**: All strings in Go template expressions must remain on a single line. This includes:

- Function parameters: `"long string value"`
- Dict values in `(dict "key" "value")`
- Conditional expressions
- Variable assignments

**After Running Prettier**: Always verify templates build with `make site` before committing.

**Prevention**:

- Keep template strings under 200 characters when possible
- Break complex expressions into variables first, then use short variable names
- Manually fix any split strings after Prettier formats files

#### 3. Markdown Shortcode Syntax (CRITICAL)

**Problem**: Prettier breaks Hugo shortcode closing syntax in markdown files

**Bad** (causes shortcode parsing errors):

```markdown
{{< job
title="My Job"
company="Company"

> }}
> Content here
> {{< /job >}}
```

**Good**:

```markdown
<!-- prettier-ignore -->
{{< job
title="My Job"
company="Company" >}}
Content here
{{< /job >}}
```

**Rule**: Hugo shortcode closing syntax `>}}` must not have a space. Prettier treats `>` as blockquote and adds a space.

**Solution**: Add `<!-- prettier-ignore -->` comment before shortcodes with `>}}` closing syntax, OR exclude content markdown files from Prettier (recommended).

### Files Excluded from Prettier

Some files are excluded in `.prettierignore` because the plugin cannot parse them or breaks Hugo-specific syntax:

- `layouts/partials/responsive-image.html` - Complex partial with extensive Go template logic before HTML output (causes "invalid node root" error in the plugin)
- `content/**/*.md` - **Content markdown files** - Prettier breaks Hugo shortcode syntax like `>}}` by adding spaces

### Running Prettier

```bash
# Check formatting
npx prettier --check "layouts/**/*.html"

# Format files
npx prettier --write "layouts/**/*.html"
```

## Workflow Tips

When modifying themes:

1. Check if file exists in root first (overrides theme)
2. If modifying theme directly, consider if it should be in root instead
3. Current customizations are split between `themes/dura/` (heavily modified) and `themes/henry/` (active theme)

When creating content:

- Always use Makefile commands to ensure proper date prefixes
- Slug is auto-extracted from filename (date removed)
- Set `draft: false` to publish (archetype defaults to `true`)
